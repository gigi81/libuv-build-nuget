parameters:
  rid: ''

steps:
  - checkout: self
    clean: true
    submodules: true

  - task: Bash@3
    displayName: 'Generate project'
    inputs:
      targetType: inline
      script: cmake . -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=$CMAKE_TOOLCHAIN_FILE
      workingDirectory: libuv

  - task: Bash@3
    displayName: 'Compile'
    inputs:
      targetType: inline
      script: cmake --build . --config Release
      workingDirectory: libuv

  - task: Bash@3
    displayName: 'Configure qemu'
    inputs:
      targetType: inline
      script: |
       sudo apt-get install binfmt-support
       wget https://raw.githubusercontent.com/qemu/qemu/master/scripts/qemu-binfmt-conf.sh
       chmod +x qemu-binfmt-conf.sh
       sudo ./qemu-binfmt-conf.sh --systemd aarch64

  - task: Bash@3
    displayName: 'Run tests (on qemu)'
    inputs:
      targetType: inline
      script: ./uv_run_tests
      workingDirectory: libuv
      
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: 'libuv/libuv.so'
      artifactName: ${{ parameters.rid }}
